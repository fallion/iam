# Kiwi IAM

This application is an adapter for Okta API to simplify privilege querying. 

## Quick-start

Below is a very short guide to running the application- you'd need to implement the dependencies below to get some sound output.

### Configuration

Create `.env.yaml` file and set environment variables (also check `.env-sample.yaml`).

Following is a minimal configuration needed for starting the app locally. For a list of all possible environment variables, check `config/cfg/config.go`
```yaml
PORT: 4000
APP_ENV: "dev"
USE_LOCALHOST: true # Uses localhost instead of 0.0.0.0, useful for OSX

OKTA_TOKEN: ""
OKTA_URL: "https://okta.com/api/v1"

# Path to cache used for storing user data
REDIS_HOST: "localhost"
REDIS_PORT: "6379"

# Path to the JSON file with tokens / secrets
SECRETS_PATH: "/etc/vault/secrets.json"

# Token format to be used for authentication when using in-memory tokens
TOKEN: "token_placeholder"
```

Usually, you'll need at least one configuration file containing JSON specifying authentication (configured via env var `SECRETS_PATH: "/etc/vault/secrets.json"`):
```json
{
    "tokens" : {
        "token": {
            "access":"thisisatoken"
        }
    },
    "google_ids": [
        "service.account@something.iam.gserviceaccount.com"
    ],
    "gitlab_claims": [
        "42069/master"
    ]
}
```
Kiwi-IAM accepts several types of tokens, all specified via the `Authorization: Bearer <token>` header.

 - Kiwi-IAM accepts tokens specified in this file - for this example, a proper header would be `Authorization: Bearer thisisatoken`.
 - Kiwi-IAM also accepts JWT tokens generated by Gitlab CI/CD pipelines, specified by a pair of `project_id/tag` or `project_id/branch`. You'll need to set the `GITLAB_JWK_URL` to an URL with JWKs.
 - Kiwi-IAM also accepts OIDC tokens issued by google - set google_ids that are allowed in this file. You'll also need to specify an audience in the `AUDIENCE` env variable (to define more audiences, separate them by space, e.g. `aud1 aud2`).

Note that to authenticate to the application successfully, you'll need to specify a User-Agent satisfying the following format: `<service name>/<version> (Kiwi.com <environment>) [<system info>]`.

### Running

To install go dependencies and start the project, ensure that GOPATH is set.
Then run:

```
make
make start
```

You can use `make dev` on development to reload the server automatically on file
changes.

## API Documentation

We use [`go-swagger`](https://github.com/go-swagger/go-swagger) to generate the API documentation based on the OpenAPI 2.0 specification `api/swagger.yml`.

```shell
# Opens the documentation website locally (on http://localhost:51261/docs)
make swagger-serve

# Validates the swagger schema
make swagger-validate
```

## Dependencies

### Redis (required)

Kiwi-IAM uses Redis to cache user data and privileges to comply with the limits of Okta API.

Installing Redis:

```shell
# MacOS
brew install redis
brew services start redis

# Linux
# install using your package manager
systemctl start redis

# Docker
docker run -it --rm -p 6379:6379 redis
```

You can use `redis-cli` to interact with redis (i.e. check keys and values).
Useful commands:

```shell
# Show all keys
KEYS *

# Show value for a key
GET <key>
```

You can configure the redis instance with env variables `REDIS_HOST`, `REDIS_PORT` and `REDIS_LOCK_RETRY_DELAY`.

### Okta (required)

Kiwi-IAM needs a connection to an Okta instance - you can provide it via an URL (env var `OKTA_URL: "https://okta.com/api/v1"`) and a token (env var `OKTA_TOKEN: ""`) with sufficient read privileges (see the configuration section above). 

To parse groups into permissions Kiwi-IAM searches for groups that match `^iam-[\w-]+\.([\w-]+\.?)+$` regular expression (i.e. `iam-foo.bar`). 
For any member of the Okta group `iam-foo.bar`, Kiwi-iam returns `bar` permission for application `foo`.

It is also possible to configure the caching interval to comply with Okta rate limit via the `OKTA_CACHE_INTERVAL` variable (expects a `time.Duration` value, default `4h`). To force a sync, use `/v1/cache/sync` endpoint, to check last sync time use `/v1/cache/status` endpoint.

### Datadog (optional)

In the current state, Kiwi-IAM sends its logs to datadog; there are three variables configuring this connection:
 - `APP_ENV` - environment of the application,
 - `DATADOG_ADDR` - address of the datadog instance,
 - `DD_AGENT_HOST` - host of the datadog agent.

### Sentry (optional)

Kiwi-IAM also supports Sentry, which can be configured via the following variables:
 - `APP_ENV` - environment of the application,
 - `SENTRY_DSN` - Sentry token,
 - `SENTRY_RELEASE` - Sentry release.


## Contributing

- Run `make test/all` before pushing changes.
- Commit messages should be at most 72 characters long.
- Commit messages should start with the scope of the changes introduced by the commit.

## Troubleshooting

### It cannot find go or some packages when executing some make commands

When executing `swagger`, or `protoc`, or running `make dev` (after having run `make`), it says that those commands do not exist...

In golang, the main packages are installed in your go installation `bin` folder, which defaults to `usr/local/go/bin`. When installing new packages through `make`, the binaries are installed in `$GOPATH/bin`. ([How to set GOPATH](https://github.com/golang/go/wiki/SettingGOPATH)).

To fix the issue, add both of these routes to your `$PATH`, i.e. editing your `.bashrc` or `.zshrc`.

```shell
export GOPATH=$HOME/go #example of GOPATH directory
export PATH=$PATH:/usr/local/go/bin $PATH:$GOPATH/bin
```